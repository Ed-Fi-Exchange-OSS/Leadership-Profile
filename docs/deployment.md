# Deployment

Application packages for both applications can be generated by running the following from the repository root:

```powershell
Invoke-Psake Publish
```

## Configuration

API configuration is set using .NET `appsettings.json` file. The settings can be changed by updating the file values, or by setting like-named environment variables on the host machine. The file can be updated before running `Publish` or after the package is unzipped (using a Continuous Integration transform or manually). Other config middlewares may be added in the future.

While it's best to examine the configuration yourself, the critical settings are:

- API: `ConnectionStrings.EdFi`
- API: `AuthSettings` addresses (for authentication and CORS)
- API: Email settings (if desired)

- Web UI: `API_URL` if default `window.location` handling is not suitable
- Web UI: `SCHOOL_HEADER` to set the title

## Deployment and Hosting

### Windows Server

On Windows server, you can host the API Application using IIS.

- Install the .NET 5 [**Hosting Bundle** Runtime](https://dotnet.microsoft.com/download/dotnet/5.0) on the server
- Enable IIS on the server and install the [ASP.NET Core IIS Module](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/aspnet-core-module?view=aspnetcore-5.0)
- Create new Websites in IIS, configured for each location of the unzipped packages

#### Using Node Instead of IIS

Since the Web UI application is a React app, there are several [options for hosting](https://create-react-app.dev/docs/deployment/). If not using IIS, the recommended option is using [Serve](https://github.com/vercel/serve).

- Install [Node.JS LTS](https://nodejs.org/en/) on the server
- Install Serve: `npm install -g serve`
- From the location of the unzipped package: `serve -s build -l PORT`

Serve supports multiple configuration options for hosting the app. See the [full documentation](https://github.com/vercel/serve) or call `server -h` for details.

### Linux Server

On Linux, the API can be hosted using Nginx with a reverse proxy. Follow the instructions [from Microsoft](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-5.0), making sure your build the application for the appropriate runtime.

Since Web UI application's is a static React app, its Node.JS-based hosting options are available on both Windows and Linux. Follow the recommended or linked instructions above under "Using Node Instead of IIS".

### Azure

It is possible to deploy each application to an Azure App Service using [Kudu Zip Deploy](https://docs.microsoft.com/en-us/azure/app-service/deploy-zip?tabs=cli#deploy-a-zip-package) or a Continuous Delivery service.

The App Services must be configured with the appropriate runtime (.NET 5 or Node JS). The application is not resource intensive, but be considerate of your number of users and amount of data when sizing your App Service plan.

The Web UI should be capable of running as an [Azure Static Web App](https://docs.microsoft.com/en-us/azure/static-web-apps/overview) which would be more cost effective but may require some changes to support.

**Important Note:** While the API application is .NET and will accept App Service app settings by default, the Web UI's `config.js` does not read environment variables by default. Config values must be hard-coded before packaging, or updated to support favoring environment variables. More information on how to do this can be found in the [App Service docs](https://docs.microsoft.com/en-us/azure/app-service/configure-language-nodejs?pivots=platform-linux#access-environment-variables).
